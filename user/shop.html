<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Shop - Spot On</title>

  <!-- Google Fonts & Bootstrap -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Cloudinary Widget -->
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
      padding-top: 60px;
    }
    #offcanvasToggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      border: none;
      background-color: #007bff;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .custom-toggle-btn {
      background: transparent;
      border: none;
      padding: 0.5rem;
      z-index: 20;
    }
    .custom-toggle-btn:focus {
      box-shadow: none;
      outline: none;
    }
  </style>
</head>
<body>

<!-- Offcanvas Toggle -->
<button class="custom-toggle-btn" type="button" id="offcanvasToggle" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
  <span class="navbar-toggler-icon"></span>
</button>

<!-- Offcanvas Navigation -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Spot On</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <nav class="navbar">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="activity.html">View the Pin</a></li>
        <li class="nav-item"><a class="nav-link active" href="shop.html">Store</a></li>
        <li class="nav-item"><a class="nav-link" href="guide.html">Instructions</a></li>
      </ul>
    </nav>
    <p class="mt-3">View and manage items youâ€™ve pinned to the map store.</p>
  </div>
</div>

<!-- Shop Items Grid -->
<div class="container mt-5">
  <h2 class="mb-4">Your Shop Pins</h2>
  <div id="shopList" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5"></div>

  <!-- Upload Form -->
  <form id="shopForm" class="mb-5">
    <div class="mb-3">
      <label for="title" class="form-label">Item Title</label>
      <input type="text" class="form-control" id="title" required>
    </div>
    <div class="mb-3">
      <label for="desc" class="form-label">Description</label>
      <textarea class="form-control" id="desc" rows="2" required></textarea>
    </div>
    <div class="mb-3">
      <label for="quantity" class="form-label">Quantity</label>
      <input type="number" class="form-control" id="quantity" required>
    </div>
    <div class="mb-3">
      <label for="link" class="form-label">Product Link</label>
      <input type="url" class="form-control" id="link" required>
    </div>
    <div class="mb-3">
      <label for="latitude" class="form-label">Latitude</label>
      <input type="number" step="any" class="form-control" id="latitude" required>
    </div>
    <div class="mb-3">
      <label for="longitude" class="form-label">Longitude</label>
      <input type="number" step="any" class="form-control" id="longitude" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Upload Image</label><br>
      <button type="button" class="btn btn-outline-secondary" id="uploadWidgetBtn">Upload with Cloudinary</button>
      <p id="imageStatus" class="text-muted mt-2">No image uploaded.</p>
    </div>
    <button type="submit" class="btn btn-success">Save Shop Pin</button>
  </form>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, onValue, push, set, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyADk7if-797jFI3Y3IUCnCXFSlOsFmX_3k",
    authDomain: "spoton-cit481.firebaseapp.com",
    databaseURL: "https://spoton-cit481-default-rtdb.firebaseio.com",
    projectId: "spoton-cit481",
    storageBucket: "spoton-cit481.appspot.com",
    messagingSenderId: "753873898041",
    appId: "1:753873898041:web:bde5e8f86aea63b175dbe8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const shopList = document.getElementById("shopList");
  let currentUser = null;
  let uploadedImageUrl = "";

  document.getElementById("uploadWidgetBtn").addEventListener("click", () => {
    cloudinary.createUploadWidget({
      cloudName: 'djhoct1eh',
      uploadPreset: 'ml_default'
    }, (error, result) => {
      if (!error && result && result.event === "success") {
        uploadedImageUrl = result.info.secure_url;
        document.getElementById("imageStatus").innerText = "Image uploaded.";
      }
    }).open();
  });

  onAuthStateChanged(auth, user => {
    if (!user) return window.location.href = "user/userlogin.html";
    currentUser = user;

    document.getElementById("shopForm").addEventListener("submit", e => {
      e.preventDefault();
      const title = document.getElementById("title").value;
      const desc = document.getElementById("desc").value;
      const quantity = document.getElementById("quantity").value;
      const link = document.getElementById("link").value;
      const lat = parseFloat(document.getElementById("latitude").value);
      const lng = parseFloat(document.getElementById("longitude").value);
      if (!uploadedImageUrl) return alert("Please upload an image first.");

      const newRef = push(ref(db, `pins/${currentUser.uid}/shopPins`));
      set(newRef, {
        title, description: desc, imageUrl: uploadedImageUrl,
        quantity, link, geolocation: { lat, lng }, timestamp: Date.now()
      }).then(() => alert("Shop pin saved!"));
    });

    const userShopRef = ref(db, `pins/${currentUser.uid}/shopPins`);
    onValue(userShopRef, snapshot => {
      shopList.innerHTML = '';
      const data = snapshot.val();
      if (!data) return shopList.innerHTML = "<p class='text-muted'>You have no shop pins yet.</p>";

      Object.entries(data).forEach(([id, item]) => {
        const col = document.createElement("div");
        col.className = "col";

        const card = document.createElement("div");
        card.className = "card h-100 shadow-sm";
        card.innerHTML = `
          ${item.imageUrl ? `<img src="${item.imageUrl}" class="card-img-top" style="object-fit: cover; height: 200px;">` : ""}
          <div class="card-body">
            <h5 class="card-title">${item.title || "Untitled Item"}</h5>
            <p class="card-text">${item.description || ""}</p>
            <p class="text-muted">Quantity: ${item.quantity || 0}</p>
            <div class="d-flex justify-content-between mt-2">
              <a href="${item.link}" target="_blank" class="btn btn-sm btn-outline-success">View Product</a>
              <div>
                <button class="btn btn-sm btn-outline-primary me-1" data-edit="${id}">Edit</button>
                <button class="btn btn-sm btn-outline-danger" data-delete="${id}">Delete</button>
              </div>
            </div>
          </div>
        `;

        card.querySelector(`[data-delete="${id}"]`).addEventListener("click", () => {
          if (confirm("Delete this item?")) {
            remove(ref(db, `pins/${currentUser.uid}/shopPins/${id}`));
          }
        });

        card.querySelector(`[data-edit="${id}"]`).addEventListener("click", () => {
          alert("Edit coming soon!");
        });

        col.appendChild(card);
        shopList.appendChild(col);
      });
    });
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
