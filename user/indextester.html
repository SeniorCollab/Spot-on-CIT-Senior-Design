<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Interactive Map with Editable Pins</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
    #bgvideo { position: fixed; top: 0; left: 0; min-width: 100%; min-height: 100%; z-index: -2; object-fit: cover; }
    #earth_div { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
    #offcanvasToggle { position: fixed; top: 20px; right: 20px; z-index: 20; }
  </style>
</head>
<body>
<video autoplay muted loop id="bgvideo">
  <source src="stars.mp4" type="video/mp4">
</video>

<div id="earth_div"></div>

<!-- Hamburger -->
<button class="btn btn-primary" id="offcanvasToggle" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar">
  <span class="navbar-toggler-icon"></span>
</button>

<!-- Sidebar -->
<div class="offcanvas offcanvas-end" id="offcanvasNavbar" tabindex="-1">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Spot On</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <nav class="navbar">
      <ul class="navbar-nav">
        <li class="nav-item"><a class="nav-link active" href="index.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="pins.html">Pins</a></li>
        <li class="nav-item"><a class="nav-link" href="songs.html">Songs</a></li>
        <li class="nav-item"><a class="nav-link" href="events.html">Events</a></li>
        <li class="nav-item"><a class="nav-link" href="shop.html">My Store</a></li>
      </ul>
    </nav>

    <h6 class="mt-4">Search Pins</h6>
    <form id="searchForm">
      <input type="text" class="form-control mb-2" id="searchInput" placeholder="Search by description">
      <button type="submit" class="btn btn-primary w-100">Search</button>
    </form>

    <h6 class="mt-4">Add a New Pin</h6>
    <form id="pinForm">
      <div class="mb-2"><label for="latitude" class="form-label">Latitude</label>
        <input type="number" class="form-control" id="latitude" required>
      </div>
      <div class="mb-2"><label for="longitude" class="form-label">Longitude</label>
        <input type="number" class="form-control" id="longitude" required>
      </div>
      <div class="mb-2"><label for="description" class="form-label">Description</label>
        <input type="text" class="form-control" id="description" required>
      </div>
      <button type="submit" class="btn btn-success w-100">Add Pin</button>
    </form>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="pinModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Add Pin</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">

        <div id="modalChoice" class="text-center">
          <p>Select Pin Type:</p>
          <button class="btn btn-outline-primary mb-2" id="modalBtnSimple">Pin Event</button>
          <button class="btn btn-outline-secondary mb-2" id="modalBtnDetailed">Pin Mood</button>
          <button class="btn btn-outline-success mb-2" id="modalBtnShop">Pin Shop Item</button>
        </div>

        <!-- Event -->
        <form id="simpleModalForm" class="d-none">
          <input type="text" class="form-control mb-2" id="modalTitleSimple" placeholder="Title" required>
          <input type="text" class="form-control mb-2" id="modalDescSimple" placeholder="Description" required>
          <button type="button" class="btn btn-outline-secondary mb-2" id="uploadEventBtn">Upload Event Image</button>
          <input type="hidden" id="modalImageSimple">
          <input type="number" class="form-control mb-2" id="modalLatSimple" readonly>
          <input type="number" class="form-control mb-2" id="modalLngSimple" readonly>
          <button type="submit" class="btn btn-primary w-100">Save Event Pin</button>
          <button type="button" class="btn btn-link mt-2" id="backFromSimpleModal">← Back</button>
        </form>

        <!-- Mood -->
        <form id="detailedModalForm" class="d-none">
          <input type="text" class="form-control mb-2" id="modalTitleDet" placeholder="Title" required>
          <textarea class="form-control mb-2" id="modalDescDet" placeholder="Description" rows="2" required></textarea>
          <input type="url" class="form-control mb-2" id="modalSongDet" placeholder="Song Link">
          <input type="number" class="form-control mb-2" id="modalLatDet" readonly>
          <input type="number" class="form-control mb-2" id="modalLngDet" readonly>
          <button type="submit" class="btn btn-primary w-100">Save Mood Pin</button>
          <button type="button" class="btn btn-link mt-2" id="backFromDetailedModal">← Back</button>
        </form>

        <!-- Shop -->
        <form id="shopModalForm" class="d-none">
          <input type="text" class="form-control mb-2" id="modalTitleShop" placeholder="Title" required>
          <textarea class="form-control mb-2" id="modalDescShop" placeholder="Description" rows="2" required></textarea>
          <button type="button" class="btn btn-outline-secondary mb-2" id="uploadShopBtn">Upload Shop Image</button>
          <input type="hidden" id="modalImageShop">
          <input type="number" class="form-control mb-2" id="modalNumberShop" placeholder="Quantity" required>
          <input type="url" class="form-control mb-2" id="modalLinkShop" placeholder="Link" required>
          <input type="number" class="form-control mb-2" id="modalLatShop" readonly>
          <input type="number" class="form-control mb-2" id="modalLngShop" readonly>
          <button type="submit" class="btn btn-success w-100">Save Shop Item</button>
          <button type="button" class="btn btn-link mt-2" id="backFromShopModal">← Back</button>
        </form>

      </div>
    </div>
  </div>
</div>

<script src="https://www.webglearth.com/v2/api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyADk7if-797jFI3Y3IUCnCXFSlOsFmX_3k",
    authDomain: "spoton-cit481.firebaseapp.com",
    databaseURL: "https://spoton-cit481-default-rtdb.firebaseio.com",
    projectId: "spoton-cit481",
    storageBucket: "spoton-cit481.appspot.com",
    messagingSenderId: "753873898041",
    appId: "1:753873898041:web:bde5e8f86aea63b175dbe8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);
  const earth = new WE.map("earth_div");
  earth.setView([0, 0], 2);
  WE.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "© OpenStreetMap contributors"
  }).addTo(earth);

  let currentUser = null;
  const markers = {};

  onAuthStateChanged(auth, user => {
    if (!user) return window.location.href = "user/userlogin.html";
    currentUser = user;
    loadPinsForCurrentUser();
  });

  function loadPinsForCurrentUser() {
    const userRef = ref(db, `pins/${currentUser.uid}`);
    onValue(userRef, snapshot => {
      clearAllMarkers();
      const data = snapshot.val();
      if (!data) return;

      ["eventPins", "moodPins", "shopPins"].forEach(type => {
        const group = data[type];
        if (!group) return;
        Object.entries(group).forEach(([id, pin]) => {
          const m = WE.marker([pin.geolocation.lat, pin.geolocation.lng]).addTo(earth);
          let popup = `<strong>${pin.title}</strong><br>${pin.description}`;
          if (pin.songLink) popup += `<br><a href="${pin.songLink}" target="_blank">Song</a>`;
          popup += `
         <br>
          <button class="btn btn-sm btn-primary mt-2 me-2" onclick="editPin('${type}','${id}')">Edit</button>
          <button class="btn btn-sm btn-danger mt-2" onclick="deletePin('${type}','${id}')">Delete</button>
          `;
          m.bindPopup(popup);
          markers[id] = m;
        });
      });
    });
  }

  function clearAllMarkers() {
    for (const id in markers) {
      markers[id].removeFrom(earth);
      delete markers[id];
    }
  }

  window.deletePin = function (type, pinId) {
    const pinRef = ref(db, `pins/${currentUser.uid}/${type}/${pinId}`);
    remove(pinRef)
      .then(() => {
        if (markers[pinId]) {
          markers[pinId].removeFrom(earth);
          delete markers[pinId];
        }
      })
      .catch(err => alert("Could not delete pin: " + err.message));
  };

  window.editPin = function (type, pinId) {
  const pinPath = `pins/${currentUser.uid}/${type}/${pinId}`;
  const pinRef = ref(db, pinPath);

  onValue(pinRef, snapshot => {
    const pin = snapshot.val();
    if (!pin) return alert("Pin not found.");

    const newTitle = prompt("Edit Title:", pin.title);
    const newDesc = prompt("Edit Description:", pin.description);
    if (!newTitle || !newDesc) return;

    // Optional: edit songLink or other fields here

    set(ref(db, pinPath), {
      ...pin, // keep existing values (like lat/lng)
      title: newTitle,
      description: newDesc
    });
    alert("Pin updated! Please click outside and reopen the pin to see changes.");
  }, {
    onlyOnce: true
  });
};
  
</script>
</body>
</html>



